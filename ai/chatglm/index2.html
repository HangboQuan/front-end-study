<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatGPT-3.5 Interaction</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        #chat-container {
            width: 80%;
            max-width: 800px;
            height: 70vh;
            margin-top: 1vh;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            overflow: auto;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 20px;
        }

        .message {
            margin: 10px 0;
            overflow-wrap: break-word;
            font-size: 16px;
            padding: 10px;
            border-radius: 8px;
            max-width: 70%;
        }

        .user-message {
            text-align: right;
            align-self: flex-end;
            background-color: #4CAF50;
            color: #fff;
        }

        .bot-message {
            text-align: left;
            background-color: #2196F3;
            color: #fff;
        }

        #input-container {
            width: 80%;
            max-width: 600px;
            background-color: #f0f0f0;
            padding: 10px;
            border-top: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            bottom: 5vh;
            border-radius: 12px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        }

        #user-input {
            flex: 1;
            padding: 8px;
            margin-right: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }

        #send-button {
            padding: 8px;
            border: none;
            background-color: #4CAF50;
            color: #fff;
            cursor: pointer;
            border-radius: 4px;
            font-size: 16px;
        }
    </style>
</head>

<body>
    <div id="chat-container">
        <!-- Chat messages will be displayed here -->
    </div>

    <div id="input-container">
        <input type="text" id="user-input" placeholder="Type your message...">
        <button id="send-button" onclick="sendMessage()">Send</button>
    </div>

    <script>
        const chatContainer = document.getElementById('chat-container');
            const userInput = document.getElementById('user-input');
            let eventSource = null;

            function appendMessage(sender, content, className) {
                const message = document.createElement('div');
                message.className = `message ${className}`;
                message.innerHTML = `<strong>${sender}:</strong> ${content}`;
                chatContainer.appendChild(message);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }


            function handleSpecialEvent(content) {
                    // 处理特殊事件，例如 event:add
                    const parts = content.split(' ');
                    if (parts[0] === 'event:add') {
                        appendMessage('ChatGPT', parts.slice(1).join(' '), 'bot-message');
                    }
                }

                function handleEventStreamData(data) {
                        const lines = data.split('\n');
                        for (const line of lines) {
                            const keyValue = line.split(':');
                            if (keyValue.length === 2) {
                                const key = keyValue[0].trim();
                                const value = keyValue[1].trim();
                                if (key === 'data') {
                                    appendMessage(value, 'bot-message');
                                }
                            }
                        }
                    }
                // function handleEventStreamData(data) {
                //     const lines = data.split('\n');
                //     let currentEvent = '';
                //     let currentMessage = '';

                //     for (const line of lines) {
                //         if (line.startsWith('data:')) {
                //             const message = line.substring('data: '.length).trim();

                //             if (currentEvent === 'event:add') {
                //                 currentMessage += message + ' ';
                //                 handleSpecialEvent(currentMessage);
                //             }
                //         } else if (line.startsWith('event: ')) {
                //             currentEvent = line.substring('event: '.length).trim();
                //         } else if (line === '') {
                //             // Empty line indicates the end of an event
                //             if (currentEvent === 'event:add') {
                //                 appendMessage('ChatGPT', currentMessage.trim(), 'bot-message');
                //             }

                //             // Reset for the next event
                //             currentEvent = '';
                //             currentMessage = '';
                //         }
                //     }
                // }
            // function handleEventStreamData(data) {
            //     const lines = data.split('\n');
            //     for (const line of lines) {
            //         if (line.startsWith('event:add')) {
            //             const message = line.substring('event:add'.length).trim();
            //             appendMessage('ChatGPT', message, 'bot-message');
            //         } else if (line.startsWith('event:finish')) {
            //             console.log("Task finished");
            //             // 在这里处理任务完成的逻辑
            //         }
            //     }
            // }

            function closeSSEConnection() {
                if (eventSource) {
                    eventSource.close();
                }
            }

            function sendMessage() {
                const userMessage = userInput.value.trim();
                if (userMessage === '') return;
                appendMessage('You', userMessage, 'user-message');

                // 如果 SSE 连接不存在或已关闭，建立新的连接
                if (!eventSource || eventSource.readyState === EventSource.CLOSED) {
                    eventSource = new EventSource(`http://localhost:9090/api/model?query=${userMessage}`);

                    eventSource.onopen = function (event) {
                        console.log("SSE connection has been established");
                    }

                    eventSource.onmessage = function (event) {
                        console.log(event);
                        console.log("message:", eventSource.readyState);

                        handleEventStreamData(event.data);
                    }

                    eventSource.onerror = function (event) {
                        console.error("SSE error:", event);
                        console.log("Ready State:", eventSource.readyState);
                        if (eventSource.readyState === EventSource.CLOSED) {
                            console.log("SSE connection is closed");
                        } else {
                            console.log("SSE connection is still open");
                        }

                        eventSource.close();
                        console.log("error");
                    }

                    eventSource.onclose = function (event) {
                        console.log("SSE connection is closed");
                    }
                }

                userInput.value = ''; // 清空输入框
            }

            document.getElementById('user-input').addEventListener('keydown', function (event) {
                if (event.key === 'Enter') {
                    sendMessage();
                }
            });
        </script>
    </script>
</body>

</html>